# -*- coding: utf-8 -*-
"""Dataset de Calidad del Aire

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1as38xq3BzL62YDFHxjc_3-neT2GPPbpE

# üßπ Limpieza de Datos ‚Äì Proyecto  
## Dataset de Calidad del Aire (MINAM / SINCA) ‚Äì Regi√≥n Arequipa

Este cuaderno documenta el proceso de **limpieza y preprocesamiento del dataset de calidad del aire**, previo a su uso como **an√°lisis ambiental complementario** en el proyecto:

**‚ÄúDise√±o de un modelo predictivo de infecciones respiratorias agudas en la regi√≥n Arequipa incorporando variables clim√°ticas y evidencia ambiental‚Äù.**

El proceso incluye la **carga del dataset original, correcci√≥n de formato, filtrado espacial, normalizaci√≥n de tipos de datos, agregaci√≥n temporal a nivel semanal y evaluaci√≥n de la calidad de la informaci√≥n**, siguiendo buenas pr√°cticas de ciencia de datos aplicadas a estudios epidemiol√≥gicos ambientales.

---

## üìå Descripci√≥n

El dataset de calidad del aire proviene del **Ministerio del Ambiente del Per√∫ (MINAM)**, a trav√©s del **Sistema Nacional de Informaci√≥n de la Calidad del Aire (SINCA)**.  
Contiene registros ambientales obtenidos a partir de estaciones de monitoreo que reportan concentraciones de contaminantes atmosf√©ricos y variables meteorol√≥gicas asociadas.

Los datos originales se presentan con **resoluci√≥n diaria u horaria**, y cuentan con una estructura heterog√©nea, incluyendo formatos no estandarizados (por ejemplo, separador punto y coma, valores num√©ricos almacenados como texto y m√∫ltiples campos temporales).  
Por ello, fue necesario aplicar un proceso riguroso de limpieza y transformaci√≥n antes de su an√°lisis.

Para este proyecto, el dataset fue **filtrado espacialmente para la regi√≥n Arequipa** y **agregado temporalmente a nivel semanal**, con el fin de mantener coherencia con los registros epidemiol√≥gicos de Infecciones Respiratorias Agudas (IRA).

---

## üéØ Objetivo del Dataset

El objetivo del dataset de calidad del aire es **proporcionar evidencia ambiental complementaria** que permita analizar la posible relaci√≥n entre la contaminaci√≥n atmosf√©rica y la incidencia de **Infecciones Respiratorias Agudas (IRA)** en la regi√≥n Arequipa.

Debido a la **cobertura temporal limitada** de los datos de calidad del aire disponibles para esta regi√≥n, el dataset **no se utiliza como predictor principal del modelo**, sino como **insumo descriptivo y contextual** para fortalecer la interpretaci√≥n epidemiol√≥gica de los resultados.

---

## üìä Diccionario de Datos ‚Äì Dataset Limpio y Agregado

Las siguientes variables corresponden al dataset final luego del proceso de limpieza y agregaci√≥n semanal:

| Campo          | Tipo    | Descripci√≥n                                                     |
|----------------|---------|-----------------------------------------------------------------|
| ano            | Integer | A√±o del registro ambiental                                      |
| semana         | Integer | Semana epidemiol√≥gica                                           |
| pm25_mean      | Float   | Concentraci√≥n promedio semanal de PM2.5 (¬µg/m¬≥)                |
| pm25_max       | Float   | Concentraci√≥n m√°xima semanal de PM2.5 (¬µg/m¬≥)                  |
| pm10_mean      | Float   | Concentraci√≥n promedio semanal de PM10 (¬µg/m¬≥)                 |
| temp_mean      | Float   | Temperatura promedio semanal (¬∞C)                              |
| humedad_mean   | Float   | Humedad relativa promedio semanal (%)                          |
| ozono_mean     | Float   | Concentraci√≥n promedio semanal de ozono (¬µg/m¬≥)                |

**Nota:** La variable `ozono_mean` presenta una alta proporci√≥n de valores nulos y se considera √∫nicamente para an√°lisis exploratorio.

---

## üìë √çndice

1. Importaci√≥n de librer√≠as  
2. Carga del Dataset  
3. Exploraci√≥n Inicial  
4. Correcci√≥n de Formato y Tipos de Datos  
5. Filtrado Espacial (Regi√≥n Arequipa)  
6. Agregaci√≥n Temporal Semanal  
7. Evaluaci√≥n de Calidad del Dato  
8. Exportaci√≥n del Dataset Limpio  

---

## 1. Importaci√≥n de librer√≠as
"""

!pip install polars gdown
import polars as pl
import numpy as np
import matplotlib.pyplot as plt
import unicodedata
import gdown

"""## 2. Descarga el archivo desde Google Drive"""

import gdown

file_id = "1mig7zh4yrvEjCEf46tbLYuDiO2tXWG6y"
url = f"https://drive.google.com/uc?id={file_id}"
gdown.download(url, "calidad_aire.csv", quiet=False)

"""## 3) Carga el archivo de forma eficiente con Polars"""

import polars as pl

df_air = pl.scan_csv(
    "calidad_aire.csv",
    separator=";",
    infer_schema_length=1000,
    ignore_errors=True
)

df_air.columns

"""##4) Filtra solo Arequipa para reducir el peso del dataset"""

df_air_arequipa = df_air.filter(
    pl.col("DEPARTAMENTO").str.to_uppercase() == "AREQUIPA"
)

df_air_arequipa = df_air_arequipa.with_columns(
    pl.col("FECHA_INICIO")
    .str.strptime(pl.Date, strict=False)
    .alias("fecha")
)

"""##5) Crea columnas de a√±o y semana"""

df_air_arequipa = df_air_arequipa.with_columns([
    pl.col("fecha").dt.year().alias("ano"),
    pl.col("fecha").dt.week().alias("semana")
])

"""##6) Seleccionar contaminantes reales (seg√∫n tu dataset)"""

df_air_arequipa = df_air_arequipa.select([
    "ano",
    "semana",
    "PM2.5",
    "PM10",
    "TEMPERATURA",
    "HUMEDAD_RELATIVA",
    "OZONO"
])

"""##7) Agregaci√≥n semanal (clave)"""

df_air_weekly = (
    df_air_arequipa
    .group_by(["ano", "semana"])
    .agg([
        pl.col("PM2.5").mean().alias("pm25_mean"),
        pl.col("PM2.5").max().alias("pm25_max"),
        pl.col("PM10").mean().alias("pm10_mean"),
        pl.col("TEMPERATURA").mean().alias("temp_mean"),
        pl.col("HUMEDAD_RELATIVA").mean().alias("humedad_mean"),
        pl.col("OZONO").mean().alias("ozono_mean"),
    ])
)

"""##8) Ejecutar y guardar"""

df_air_weekly = df_air_weekly.collect()

df_air_weekly.write_csv("calidad_aire_arequipa_semanal.csv")

"""##9)Verificaci√≥n final del dataset de calidad del aire"""

df_air_weekly.select("ano").unique().sort("ano")
df_air_weekly.select("ano").unique()
df_air_weekly.select([
    pl.col("ano").min().alias("ano_min"),
    pl.col("ano").max().alias("ano_max")
])

df_air_weekly.columns
df_air_weekly.shape
df_air_weekly.select("ano").unique().sort("ano")
df_air_weekly.tail()

"""***Problema: Las columnas num√©ricas est√°n como STRING***

**PASO 1 ‚Äî Convertir columnas a num√©rico (ANTES de agregar)**
"""

df_air_arequipa = df_air_arequipa.with_columns([
    pl.col("PM2.5").str.replace(",", ".").cast(pl.Float64, strict=False).alias("PM2_5"),
    pl.col("PM10").str.replace(",", ".").cast(pl.Float64, strict=False).alias("PM10_f"),
    pl.col("TEMPERATURA").str.replace(",", ".").cast(pl.Float64, strict=False).alias("TEMP_f"),
    pl.col("HUMEDAD_RELATIVA").str.replace(",", ".").cast(pl.Float64, strict=False).alias("HUM_f"),
    pl.col("OZONO").str.replace(",", ".").cast(pl.Float64, strict=False).alias("OZONO_f"),
])

"""**PASO 2 ‚Äî Seleccionar solo columnas limpias**"""

df_air_arequipa = df_air_arequipa.select([
    "ano",
    "semana",
    "PM2_5",
    "PM10_f",
    "TEMP_f",
    "HUM_f",
    "OZONO_f"
])

"""**PASO 3 ‚Äî Agregar nuevamente**"""

df_air_weekly = (
    df_air_arequipa
    .group_by(["ano", "semana"])
    .agg([
        pl.col("PM2_5").mean().alias("pm25_mean"),
        pl.col("PM2_5").max().alias("pm25_max"),
        pl.col("PM10_f").mean().alias("pm10_mean"),
        pl.col("TEMP_f").mean().alias("temp_mean"),
        pl.col("HUM_f").mean().alias("humedad_mean"),
        pl.col("OZONO_f").mean().alias("ozono_mean"),
    ])
)

df_air_weekly = df_air_weekly.collect()

"""**PASO 4 ‚Äî Verificar otra vez (igual que antes)**"""

df_air_weekly.head()
df_air_weekly.null_count()
df_air_weekly.shape

df_air_weekly.columns
df_air_weekly.shape
df_air_weekly.select("ano").unique().sort("ano")
df_air_weekly.tail()

"""**Excelente. Este resultado ya es definitivo y muy valioso.
Ahora s√≠ podemos hablar, con datos reales en la mano**

Interpretaci√≥n t√©cnica de tu dataset ambiental final

Tu dataset df_air_weekly qued√≥ as√≠:

Observaciones: 5 semanas

Periodo: semanas 48‚Äì52 del a√±o 2021

Variables v√°lidas (num√©ricas y no nulas):

pm25_mean ‚úÖ

pm25_max ‚úÖ

pm10_mean ‚úÖ

temp_mean ‚úÖ

humedad_mean ‚úÖ

Variable NO utilizable:

ozono_mean ‚Üí 100% nula

Esto es un resultado realista para SINCA/MINAM en Arequipa.
"""

df_air_weekly.shape
df_air_weekly.null_count()

df_air_weekly.shape

df_air_weekly.dtypes

df_air_weekly.head()