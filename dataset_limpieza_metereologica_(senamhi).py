# -*- coding: utf-8 -*-
"""Dataset_limpieza_metereologica (SENAMHI)

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1YVLjD8-xay_Ic79W3Se3kaEfEP_O-7Cf

# üßπ Limpieza de Datos ‚Äì Proyecto  
## Dataset de Calidad del Aire (MINAM / SINCA) ‚Äì Regi√≥n Arequipa

Este cuaderno documenta el proceso de **limpieza y preprocesamiento del dataset de calidad del aire**, previo a su uso como **an√°lisis ambiental complementario** en el proyecto:

**‚ÄúDise√±o de un modelo predictivo de infecciones respiratorias agudas en la regi√≥n Arequipa incorporando variables clim√°ticas y evidencia ambiental‚Äù.**

El proceso incluye la **carga del dataset original, correcci√≥n de formato, filtrado espacial, normalizaci√≥n de tipos de datos, agregaci√≥n temporal a nivel semanal y evaluaci√≥n de la calidad de la informaci√≥n**, siguiendo buenas pr√°cticas de ciencia de datos aplicadas a estudios epidemiol√≥gicos ambientales.

---

## üìå Descripci√≥n

El dataset de calidad del aire proviene del **Ministerio del Ambiente del Per√∫ (MINAM)**, a trav√©s del **Sistema Nacional de Informaci√≥n de la Calidad del Aire (SINCA)**.  
Contiene registros ambientales obtenidos a partir de estaciones de monitoreo que reportan concentraciones de contaminantes atmosf√©ricos y variables meteorol√≥gicas asociadas.

Los datos originales se presentan con **resoluci√≥n diaria u horaria**, y cuentan con una estructura heterog√©nea, incluyendo formatos no estandarizados (por ejemplo, separador punto y coma, valores num√©ricos almacenados como texto y m√∫ltiples campos temporales).  
Por ello, fue necesario aplicar un proceso riguroso de limpieza y transformaci√≥n antes de su an√°lisis.

Para este proyecto, el dataset fue **filtrado espacialmente para la regi√≥n Arequipa** y **agregado temporalmente a nivel semanal**, con el fin de mantener coherencia con los registros epidemiol√≥gicos de Infecciones Respiratorias Agudas (IRA).

---

## üéØ Objetivo del Dataset

El objetivo del dataset de calidad del aire es **proporcionar evidencia ambiental complementaria** que permita analizar la posible relaci√≥n entre la contaminaci√≥n atmosf√©rica y la incidencia de **Infecciones Respiratorias Agudas (IRA)** en la regi√≥n Arequipa.

Debido a la **cobertura temporal limitada** de los datos de calidad del aire disponibles para esta regi√≥n, el dataset **no se utiliza como predictor principal del modelo**, sino como **insumo descriptivo y contextual** para fortalecer la interpretaci√≥n epidemiol√≥gica de los resultados.

---

## üìä Diccionario de Datos ‚Äì Dataset Limpio y Agregado

Las siguientes variables corresponden al dataset final luego del proceso de limpieza y agregaci√≥n semanal:

| Campo          | Tipo    | Descripci√≥n                                                     |
|----------------|---------|-----------------------------------------------------------------|
| ano            | Integer | A√±o del registro ambiental                                      |
| semana         | Integer | Semana epidemiol√≥gica                                           |
| pm25_mean      | Float   | Concentraci√≥n promedio semanal de PM2.5 (¬µg/m¬≥)                |
| pm25_max       | Float   | Concentraci√≥n m√°xima semanal de PM2.5 (¬µg/m¬≥)                  |
| pm10_mean      | Float   | Concentraci√≥n promedio semanal de PM10 (¬µg/m¬≥)                 |
| temp_mean      | Float   | Temperatura promedio semanal (¬∞C)                              |
| humedad_mean   | Float   | Humedad relativa promedio semanal (%)                          |
| ozono_mean     | Float   | Concentraci√≥n promedio semanal de ozono (¬µg/m¬≥)                |

**Nota:** La variable `ozono_mean` presenta una alta proporci√≥n de valores nulos y se considera √∫nicamente para an√°lisis exploratorio.

---

## üìë √çndice

1. Importaci√≥n de librer√≠as  
2. Carga del Dataset  
3. Exploraci√≥n Inicial  
4. Correcci√≥n de Formato y Tipos de Datos  
5. Filtrado Espacial (Regi√≥n Arequipa)  
6. Agregaci√≥n Temporal Semanal  
7. Evaluaci√≥n de Calidad del Dato  
8. Exportaci√≥n del Dataset Limpio  

---

## üîó Fuente del Dataset

El dataset original de calidad del aire fue obtenido desde Google Drive, a partir de los datos abiertos del MINAM/SINCA:

https://drive.google.com/file/d/1u_sHKoKYsncLmR5lBL15cD79fJ4IUpmG/view?usp=drive_link

---

## 1. Importaci√≥n de librer√≠as
"""

!pip install polars gdown
import polars as pl
import numpy as np
import matplotlib.pyplot as plt
import unicodedata
import gdown

"""## 2. Descarga el archivo desde Google Drive

> Agregar bloque entrecomillado


"""

import os

os.makedirs("data/raw", exist_ok=True)
os.makedirs("data/clean", exist_ok=True)

print("Carpetas creadas correctamente")

file_id = "1u_sHKoKYsncLmR5lBL15cD79fJ4IUpmG"
url = f"https://drive.google.com/uc?id={file_id}"
output = "data/raw/dataset_meteorologico.csv"

gdown.download(url, output, quiet=False)

"""##PASO 3: Cargar y explorar el dataset"""

import polars as pl

df_clima = pl.read_csv(
    "data/raw/dataset_meteorologico.csv",
    infer_schema_length=1000
)

print("Tama√±o:", df_clima.shape)
print("Columnas:")
print(df_clima.columns)
print("Tipos:")
print(df_clima.dtypes)

df_clima = pl.read_csv(
    "data/raw/dataset_meteorologico.csv",
    infer_schema_length=1000
)

df_clima.head()

"""## Paso 4: Filtrado espacial: Regi√≥n Arequipa"""

df_clima = df_clima.filter(
    pl.col("DEPARTAMENTO").str.to_uppercase() == "AREQUIPA"
)

"""##PASO 5 : Normalizaci√≥n de fecha (CR√çTICO)"""

df_clima = df_clima.with_columns(
    pl.col("FECHA")
    .cast(pl.Utf8)
    .str.strptime(pl.Date, "%Y%m%d")
    .alias("fecha")
)

"""##PASO 6: Crear variables temporales (alineaci√≥n con IRA)"""

df_clima = df_clima.with_columns([
    pl.col("fecha").dt.year().alias("ano"),
    pl.col("fecha").dt.week().alias("semana")
])

"""## PASO 7: Selecci√≥n de variables relevantes"""

df_clima = df_clima.select([
    "ano",
    "semana",
    "TEMP",
    "HR",
    "PP"
])

"""## PASO 8 : Conversi√≥n de tipos num√©ricos
Aunque ya vienen como Float64, esto asegura robustez.
"""

df_clima = df_clima.with_columns([
    pl.col("TEMP").cast(pl.Float64),
    pl.col("HR").cast(pl.Float64),
    pl.col("PP").cast(pl.Float64)
])

"""##PASO 9 : Agregaci√≥n temporal semanal (PASO CLAVE)"""

df_clima_weekly = (
    df_clima
    .group_by(["ano", "semana"])
    .agg([
        pl.col("TEMP").mean().alias("temp_mean"),
        pl.col("TEMP").max().alias("temp_max"),
        pl.col("TEMP").min().alias("temp_min"),
        pl.col("HR").mean().alias("humedad_mean"),
        pl.col("PP").sum().alias("precipitacion_sum"),
    ])
    .sort(["ano", "semana"])
)

df_clima_weekly.head()

"""##PASO 10 : Evaluaci√≥n de calidad del dato"""

df_clima_weekly.shape
df_clima_weekly.null_count()
df_clima_weekly.dtypes

"""##PASO 11 : Guardar dataset limpio"""

df_clima_weekly.write_csv("data/clean/clima_arequipa_semanal.csv")

df_clima_weekly.shape

df_clima_weekly.null_count()

df_clima_weekly.write_csv("clima_arequipa_semanal.csv")

from google.colab import files
files.download("clima_arequipa_semanal.csv")